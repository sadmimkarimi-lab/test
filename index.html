<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ§Ù†Ú©ÛŒØªØ§ | Tankita</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/dist/font-face.css" rel="stylesheet" />

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family: Vazir, Vazirmatn, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top,#111827,#020617);
      color:#f9fafb;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:16px;
    }

    .game-wrapper{
      width:100%;
      max-width:420px;
    }

    /* Ù‡Ø¯Ø± Ú©Ø§Ø±Øªâ€ŒØ´Ø¯Ù‡ */
.header{
  display:flex;
  flex-direction: row;          /* Ø±Ø¯ÛŒÙ Ù…Ø¹Ù…ÙˆÙ„ÛŒ */
  justify-content:space-between;
  align-items:center;
  gap:10px;
  background:rgba(15,23,42,0.95);
  border-radius:20px;
  padding:8px 12px;
  border:1px solid rgba(148,163,184,.5);
  margin-bottom:12px;
  box-shadow:0 10px 30px rgba(15,23,42,.9);
}

    
/* Ø±Ø§Ø³Øª Ù‡Ø¯Ø±: Ù„ÙˆÚ¯Ùˆ Ø§ÙˆÙ„ + Ø¹Ù†ÙˆØ§Ù† Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† */
.header-right {
  display: flex;
  flex-direction: row; 
  align-items: center;
  gap: 6px;
  text-align: right;
  flex: 1;
  justify-content: flex-start;
}
    .logo-badge{
      width:64px;
      height:64px;
      border-radius:16px;
      background:radial-gradient(circle at top,#38bdf8,#0f172a);
      box-shadow:0 0 18px rgba(56,189,248,.9);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:20px;
      letter-spacing:1px;
      color:#e0faff;
      flex-shrink:0;
    }
  .title-block{
  display:flex;
  flex-direction:column;
  gap:2px;
  text-align:right;   
}
  .title-row{
  display:flex;
  align-items:center;
  gap:6px;
  justify-content:flex-start;
}
    h1{
      font-size:18px;
      font-weight:800;
      white-space:nowrap;
    }
    .subtitle{
      font-size:12px;
      opacity:.9;
      white-space:nowrap;
    }

    /* Ú†Ù¾ Ù‡Ø¯Ø±: ÙÙ‚Ø· Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ */
    .header-left{
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:6px;
    }
    .header-link{
      background:linear-gradient(135deg,#3b82f6,#0ea5e9);
      border:1px solid rgba(191,219,254,.9);
      color:#e5e7eb;
      cursor:pointer;
      padding:6px 11px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      white-space:nowrap;
      box-shadow:0 6px 18px rgba(37,99,235,.8);
      transition:all .15s;
    }
    .header-link:hover{
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      border-color:rgba(190,242,100,1);
      color:#f9fafb;
      transform:translateY(-1px) scale(1.03);
      box-shadow:0 10px 24px rgba(34,197,94,.85);
    }
    .header-link:active{
      transform:translateY(1px) scale(.97);
      box-shadow:0 3px 10px rgba(15,23,42,.9);
    }

    .game-panel{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000);
      border-radius:22px;
      padding:12px 12px 16px;
      box-shadow:0 16px 40px rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.3);
    }

    .canvas-wrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.35);
      margin-bottom:10px;
    }
    canvas{ display:block; width:100%; height:auto; }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ù„ÛŒ Ù¾ÛŒÚ©Ø³Ù„â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª */
    .stat-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.5);
      white-space:nowrap;
      transition:all .2s;
      font-size:11px;
    }
    .dot{
      width:6px;height:6px;border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.9);
    }
    .badge-level{
      background:rgba(59,130,246,.2);
      border-color:rgba(59,130,246,.7);
    }
    .badge-coins{
      background:rgba(234,179,8,.12);
      border-color:rgba(234,179,8,.6);
    }
    .stat-pill.danger{
      background:rgba(248,113,113,0.2);
      border-color:#ef4444;
      animation:dangerPulse 0.6s ease-in-out 0s 2;
    }
    @keyframes dangerPulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.08);}
      100%{transform:scale(1);}
    }

    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ HUD (ØµØ¯Ø§ / Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª) */
    .top-actions{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .top-icon-btn{
      width:30px;
      height:30px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:linear-gradient(135deg,#6366f1,#0ea5e9);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      padding:0;
      user-select:none;
      -webkit-user-select:none;
      box-shadow:0 6px 16px rgba(37,99,235,.8);
      transition:all .15s;
    }
    .top-icon-btn:hover{
      transform:translateY(-1px) scale(1.03);
      box-shadow:0 9px 22px rgba(59,130,246,.9);
    }
    .top-icon-btn:active{
      transform:translateY(1px) scale(.96);
      box-shadow:0 3px 10px rgba(15,23,42,.9);
    }

    /* HUD Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ */
    .hud{
      margin-top:6px;
      font-size:11px;
    }
    .hud-main{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;
      margin-bottom:6px;
    }

    /* Ú©Ø§Ø¯Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ù‡Ù…â€ŒÙ‚Ø¯ Ø¨Ø§ Ø¬ÙˆÙ†) */
    .shop-bar{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.95);
      box-shadow:0 4px 14px rgba(15,23,42,0.9);
    }
    .shop-items{
      display:flex;
      align-items:center;
      gap:4px;
      flex:1;
      justify-content:flex-start;
    }
    .shop-item{
      display:flex;
      align-items:center;
      gap:3px;
      padding:2px 5px;
      border-radius:999px;
      background:rgba(30,64,175,0.8);
      border:1px solid rgba(129,140,248,0.9);
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      font-size:11px;
    }
    .shop-item.disabled{
      opacity:.4;
      cursor:not-allowed;
    }
    .shop-icon{
      font-size:13px;
    }
    .shop-count{
      min-width:12px;
      text-align:center;
      font-weight:700;
    }
    .shop-cart{
      width:30px;
      height:30px;
      border-radius:999px;
      border:1px solid rgba(248,113,113,0.9);
      background:radial-gradient(circle at center,#fecaca,#f97373);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(248,113,113,0.8);
      user-select:none;
      -webkit-user-select:none;
    }
    .shop-cart:active{
      transform:scale(.95) translateY(1px);
      box-shadow:0 4px 12px rgba(15,23,42,.9);
    }

    .hud-sub{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    /* ØªÙˆØ¶ÛŒØ­Ø§Øª Ø²ÛŒØ± Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ */
    .controls-hint{
      margin-top:6px;
      font-size:11px;
      opacity:.85;
      line-height:1.7;
      text-align:right;
    }

    /* Ù¾ÛŒØ§Ù… Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´ Ú©Ù†Ø§Ø± Ø§Ù…ØªÛŒØ§Ø² */
    .hud-hint{
      font-size:13px;
      opacity:.95;
      font-weight:500;
    }

    .overlay{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      background:radial-gradient(circle at center,rgba(15,23,42,.35),rgba(15,23,42,.96));
      text-align:center; padding:14px; z-index:3;
    }
    .overlay.hidden{display:none;}
    .overlay h2{ font-size:19px; margin-bottom:6px; }
    .overlay p{
      font-size:12px; opacity:.9; margin-bottom:10px; line-height:1.9;
    }
    .overlay button{
      border:none; border-radius:999px;
      padding:7px 18px; font-size:13px; font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#ec4899,#6366f1);
      color:#fff; box-shadow:0 10px 26px rgba(129,140,248,.9);
      margin:2px;
    }
    .overlay .secondary{
      background:transparent;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:none;
    }

    /* Controls */
    .controls{
      display:flex; justify-content:space-between;
      gap:10px; margin-top:8px; direction:ltr;
      animation:controlsPulse 3s ease-in-out 0s 2;
    }
    @keyframes controlsPulse{
      0%,100%{transform:translateY(0);}
      50%{transform:translateY(-3px);}
    }
    .ctrl-btn{
      flex:1; padding:14px 0; border-radius:22px;
      border:1px solid rgba(15,23,42,0.9);
      cursor:pointer; font-size:20px; font-weight:700;
      background:radial-gradient(circle at top,#1d4ed8,#0ea5e9);
      color:#e0faff; box-shadow:0 10px 32px rgba(59,130,246,.6);
      transition:transform .1s, box-shadow .15s, transform .15s;
      user-select:none;
      -webkit-user-select:none;
      text-shadow:0 0 8px rgba(15,23,42,.9);
    }
    .ctrl-btn:active{
      transform:scale(.9) translateY(1px);
      box-shadow:0 4px 16px rgba(15,23,42,.8);
    }
    .ctrl-btn.fire{
      flex:1.4;
      background:radial-gradient(circle at top,#f97316,#e11d48);
      box-shadow:0 12px 36px rgba(239,68,68,.7);
    }

    /* Modal base */
    .modal{
      position:fixed; inset:0;
      display:flex; justify-content:center; align-items:center;
      background:rgba(15,23,42,0.9);
      z-index:50;
    }
    .modal.hidden{ display:none; }
    .modal-box{
      background:radial-gradient(circle at top,#020617,#020617 60%,#000);
      border-radius:20px;
      padding:18px;
      max-width:380px;
      width:92%;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 18px 40px rgba(15,23,42,0.95);
      text-align:right;
    }
    .modal-box h2{ font-size:16px; margin-bottom:6px; }
    .modal-box p{
      font-size:12px; line-height:1.9; opacity:0.9; margin-bottom:10px;
    }
    .modal-actions{
      display:flex; justify-content:flex-end; gap:8px; margin-top:10px;
    }
    .modal-actions button{
      border:none; border-radius:999px;
      padding:6px 14px; font-size:12px; cursor:pointer;
      background:linear-gradient(135deg,#6366f1,#0ea5e9);
      color:#f9fafb;
    }
    .modal-actions .secondary{
      background:transparent;
      border:1px solid rgba(148,163,184,.6);
    }

    /* Shop modal */
    .shop-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:8px;
    }
    .shop-card{
      background:rgba(2,6,23,.9);
      border:1px solid rgba(148,163,184,.35);
      border-radius:14px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .shop-info{
      display:flex; flex-direction:column; gap:4px;
    }
    .shop-title{
      font-size:13px; font-weight:800;
    }
    .shop-desc{
      font-size:11px; opacity:.85; line-height:1.7;
    }
    .shop-buy{
      border:none; border-radius:999px;
      padding:6px 12px; font-size:12px; font-weight:700;
      cursor:pointer;
      background:linear-gradient(135deg,#f59e0b,#ef4444);
      color:#fff;
      white-space:nowrap;
      box-shadow:0 8px 20px rgba(239,68,68,.7);
    }
    .shop-buy:disabled{
      opacity:.5; cursor:not-allowed;
      box-shadow:none;
    }
    .shop-coins{
      margin-top:4px;
      font-size:12px;
      opacity:.9;
    }

    @media(max-width:480px){
      h1{font-size:17px;}
      .subtitle{font-size:11px;}
      .logo-badge{width:56px;height:56px;}
    }


/* ===== Ø§ÛŒÙ†ØªØ±ÙˆÛŒ ÙˆÛŒØ¯Ø¦ÙˆÛŒÛŒ ===== */
.intro-screen{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:100;
}

.intro-video{
  width:100%;
  max-width:420px;
  border-radius:18px;
  background:#000;
  box-shadow:0 20px 40px rgba(0,0,0,.9);
}

.intro-controls{
  margin-top:12px;
  display:flex;
  gap:10px;
}

.intro-btn{
  border:none;
  border-radius:999px;
  padding:6px 14px;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  white-space:nowrap;
}

.intro-btn.mute{
  background:#111827;
  color:#e5e7eb;
  border:1px solid rgba(148,163,184,.7);
}

.intro-btn.skip{
  background:linear-gradient(135deg,#f97316,#ec4899);
  color:#fff;
  box-shadow:0 10px 24px rgba(248,113,113,.8);
}

.hidden-game{
  display:none;
}

    
  </style>
</head>
<body>
<!-- ØµÙØ­Ù‡ Ø§ÛŒÙ†ØªØ±ÙˆÛŒ ÙˆÛŒØ¯Ø¦ÙˆÛŒÛŒ -->
  <div id="introScreen" class="intro-screen">
    <video
      id="introVideo"
      class="intro-video"
      src="https://cdnfa.com/irangiah/a9be/uploads/tank/tankk.mp4"
      autoplay
      playsinline
      muted
    ></video>

<audio id="startSfx" src="https://cdn.jsdelivr.net/gh/itsrahaa/sfx/tank-start.mp3" preload="auto"></audio>
    
    <div class="intro-controls">
      <button id="introMuteBtn" class="intro-btn mute">ğŸ”‡ ØµØ¯Ø§</button>
      <button id="introSkipBtn" class="intro-btn skip">Ø±Ø¯ Ú©Ø±Ø¯Ù† â­ï¸</button>
    </div>
  </div>

  <!-- Ø´Ø±ÙˆØ¹ Ù…Ø­ÛŒØ· Ø¨Ø§Ø²ÛŒ (ÙØ¹Ù„Ø§Ù‹ Ù…Ø®ÙÛŒ) -->
  <div class="game-wrapper hidden-game" id="gameWrapper">

    <!-- Ù‡Ø¯Ø± -->
    <header class="header">
      <!-- Ø±Ø§Ø³Øª: Ù„ÙˆÚ¯Ùˆ Ø¨Ø¹Ø¯ Ø¹Ù†ÙˆØ§Ù† -->
      <div class="header-right">
        <div class="logo-badge">T</div>
        <div class="title-block">
          <div class="title-row">
            <h1>ØªØ§Ù†Ú©ÛŒØªØ§</h1>
          </div>
          <div class="subtitle">Ø¨Ø§ ØªØ§Ù†Ú© Ø§Ø±Ø§Ø¯Ù‡ØŒ Ù‚Ù„Ù…Ø±Ùˆ Ø°Ù‡Ù†Øª Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†.</div>
        </div>
      </div>

      <!-- Ú†Ù¾: ÙÙ‚Ø· Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ -->
      <div class="header-left">
        <button class="header-link" id="aboutBtn">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</button>
      </div>
    </header>

    <div class="game-panel">

      <div class="canvas-wrap">
        <canvas id="gameCanvas"></canvas>

        <!-- Ø´Ø±ÙˆØ¹ -->
        <div id="startOverlay" class="overlay">
          <h2>ØªØ§Ù†Ú©ÛŒØªØ§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª ğŸš€</h2>
          <p>
            Ø¨Ø§ ØªØ§Ù†Ú© Ø§Ø±Ø§Ø¯Ù‡â€ŒØ§ØªØŒ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ Ø±Ùˆ Ù†Ø§Ø¨ÙˆØ¯ Ú©Ù† Ùˆ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡<br/>
            ØºÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ù„Ù…Ø±Ùˆ Ø°Ù‡Ù†Øª Ø±Ùˆ Ø´Ú©Ø³Øª Ø¨Ø¯Ù‡. <br>
            Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Â«Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Û±Â» Ø¨Ø²Ù†.
          </p>
          <button id="startBtn">Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Û±</button>
          <button id="continueBtn" class="secondary">Ø§Ø¯Ø§Ù…Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡</button>
        </div>

        <!-- Ù¾Ø§ÛŒØ§Ù† Ù…Ø±Ø­Ù„Ù‡ -->
        <div id="levelOverlay" class="overlay hidden">
          <h2>Ù…Ø±Ø­Ù„Ù‡ ØªÙ…ÙˆÙ… Ø´Ø¯! ğŸ‰</h2>
          <p>
            ØºÙˆÙ„ Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ù†Ø§Ø¨ÙˆØ¯ Ø´Ø¯ Ùˆ Ù…Ø³ÛŒØ± Ø°Ù‡Ù† ØªÙ…ÛŒØ² Ø´Ø¯.<br/>
            Û² Ø¬Ø§Ù† Ù‡Ø¯ÛŒÙ‡ Ú¯Ø±ÙØªÛŒØ› Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±ÛŒ Ø³Ø±Ø§Øº ØºÙˆÙ„ Ø¨Ø¹Ø¯ÛŒØŸ
          </p>
          <button id="nextLevelBtn">Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ â–¶ï¸</button>
        </div>

        <!-- Ú¯ÛŒÙ…â€ŒØ§ÙˆØ± -->
        <div id="gameOverOverlay" class="overlay hidden">
          <h2>Ù¾Ø§ÛŒØ§Ù† Ø§ÛŒÙ† Ø¯ÙˆØ± ğŸ’”</h2>
          <p>
            Ø§Ù…ØªÛŒØ§Ø² Ø§ÛŒÙ† Ø¯ÙˆØ±: <span id="finalScore">0</span><br>
            Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: <span id="bestScore">0</span>
          </p>
          <button id="restartBtn">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Û±</button>
        </div>
      </div>

      <!-- HUD Ù¾Ø§ÛŒÛŒÙ†: Ø¬Ø§Ù† / Ø³Ú©Ù‡ / ÙØ±ÙˆØ´Ú¯Ø§Ù‡ / ØµØ¯Ø§ / Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª -->
      <div class="hud">
        <div class="hud-main">
          <!-- Û±. Ø¬Ø§Ù† -->
          <span class="stat-pill" id="livesPill">
            â¤ï¸ <span id="lives">3</span>
          </span>

          <!-- Û². Ø³Ú©Ù‡ -->
          <span class="stat-pill badge-coins">
            ğŸª™ <span id="coins">0</span>
          </span>

          <!-- Û³. Ú©Ø§Ø¯Ø± ÙØ±ÙˆØ´Ú¯Ø§Ù‡ -->
          <div class="shop-bar">
            <div class="shop-items">
              <div class="shop-item" id="shieldUseBtn">
                <span class="shop-icon">ğŸ›¡</span>
                <span class="shop-count" id="shieldCount">0</span>
              </div>
              <div class="shop-item" id="rocketUseBtn">
                <span class="shop-icon">ğŸš€</span>
                <span class="shop-count" id="rocketCount">0</span>
              </div>
              <div class="shop-item" id="tripleUseBtn">
                <span class="shop-icon">âœ–ï¸3</span>
                <span class="shop-count" id="tripleCount">0</span>
              </div>
            </div>
            <button class="shop-cart" id="shopBtn" title="Ø´Ø§Ù¾">
              ğŸ›’
            </button>
          </div>

          <!-- Û´. ØµØ¯Ø§ + Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ -->
          <div class="top-actions">
            <button class="top-icon-btn" id="soundToggle" title="Ù‚Ø·Ø¹/ÙˆØµÙ„ ØµØ¯Ø§">ğŸ”Š</button>
            <button class="top-icon-btn" id="resetRunBtn" title="Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡">âŸ²</button>
          </div>
        </div>

        <!-- Ø§Ù…ØªÛŒØ§Ø² / Ù…Ø±Ø­Ù„Ù‡ + Ù¾ÛŒØ§Ù… Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´ -->
        <div class="hud-sub">
          <span class="stat-pill">
            <span class="dot"></span> Ø§Ù…ØªÛŒØ§Ø²: <span id="score">0</span>
          </span>
          <span class="stat-pill badge-level">
            Ù…Ø±Ø­Ù„Ù‡: <span id="levelLabel">Û±</span>
          </span>
          <span class="hud-hint" id="motivationText"></span>
        </div>
      </div>

      <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
      <div class="controls">
        <button class="ctrl-btn" id="leftBtn">â—€ï¸</button>
        <button class="ctrl-btn fire" id="fireBtn">ğŸ”¥</button>
        <button class="ctrl-btn" id="rightBtn">â–¶ï¸</button>
      </div>

      <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª Ø²ÛŒØ± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ -->
      <div class="controls-hint">
        <div>Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>
        <div>Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±: â—€ï¸â–¶ï¸ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©ØªØŒ Space Ø¨Ø±Ø§ÛŒ Ø´Ù„ÛŒÚ© | Ù…ÙˆØ¨Ø§ÛŒÙ„: Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</div>
      </div>

    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§ -->
  <div class="modal hidden" id="aboutModal">
    <div class="modal-box">
      <h2>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§</h2>
      <p>
        Ø·Ø§ÙˆÛŒØªØ§ ÛŒÚ© ØªÛŒÙ… Ú©ÙˆÚ†Ú© Ø§Ù…Ø§ Ø¹Ø§Ø´Ù‚ Â«Ø±Ø´Ø¯ Ø°Ù‡Ù† Ùˆ Ø¨Ø§Ø²ÛŒâ€ŒØ³Ø§Ø²ÛŒÂ» Ø§Ø³Øª.
        Ù…Ø§ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ú©Ù‡ Ù‡Ù… Ø³Ø±Ú¯Ø±Ù… Ú©Ù†Ù†Ø¯ØŒ Ù‡Ù… Ø°Ù‡Ù† Ø±Ø§ Ø¨Ù‡ Ú†Ø§Ù„Ø´ Ø¨Ú©Ø´Ù†Ø¯
        Ùˆ Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ±Ú© Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ Ùˆ Ø­Ø±Ú©Øª Ø¨Ù‡ Ø³Ù…Øª Ø®ÙˆØ¨ÛŒâ€ŒÙ‡Ø§ Ù‡Ù…Ø±Ø§Ù‡Øª Ø¨Ø§Ø´Ù†Ø¯.
      </p>
      <div class="modal-actions">
        <button class="secondary" id="aboutCloseBtn">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ -->
  <div class="modal hidden" id="shopModal">
    <div class="modal-box">
      <h2>Ø´Ø§Ù¾ ØªØ§Ù†Ú©ÛŒØªØ§ ğŸ›’</h2>
      <p>
        Ø¨Ø§ Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù‚Ø¯Ø±Øªâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡ Ø¨Ú¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ù‡Ø± ÙˆÙ‚Øª Ø®ÙˆØ§Ø³ØªÛŒ
        Ø§Ø² Ø¯Ø§Ø®Ù„ Ú©Ø§Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØ´ÙˆÙ† Ú©Ù†ÛŒ.
      </p>

      <div class="shop-coins">
        Ø³Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§: <span id="shopCoins">0</span> ğŸª™
      </div>

      <div class="shop-grid">
        <div class="shop-card">
          <div class="shop-info">
            <div class="shop-title">Ø´Ù„ÛŒÚ© Ø³Ù‡â€ŒØªØ§ÛŒÛŒ Ã—3</div>
            <div class="shop-desc">Ù‚Ø¯Ø±Øª Ø´Ù„ÛŒÚ© Ø³Ù‡â€ŒØªØ§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡Ø› ÙˆÙ‚ØªÛŒ Ù„Ø§Ø²Ù… Ø¯Ø§Ø´ØªÛŒ ÙØ¹Ø§Ù„Ø´ Ú©Ù†.</div>
            <div class="shop-desc">Ù‚ÛŒÙ…Øª: Û¶Û° ğŸª™</div>
          </div>
          <button class="shop-buy" id="buyTripleBtn">Ø®Ø±ÛŒØ¯</button>
        </div>

        <div class="shop-card">
          <div class="shop-info">
            <div class="shop-title">Ø­ÙØ§Ø¸ Ø§Ù†Ø±Ú˜ÛŒ ğŸ›¡</div>
            <div class="shop-desc">Ø³Ù¾Ø± Ù…Ø­Ø§ÙØ¸ Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø¶Ø±Ø¨Ù‡â€ŒÙ‡Ø§Ø› Ù‡Ø± ÙˆÙ‚Øª Ø®Ø·Ø± Ø±Ùˆ Ø­Ø³ Ú©Ø±Ø¯ÛŒ ÙØ¹Ø§Ù„Ø´ Ú©Ù†.</div>
            <div class="shop-desc">Ù‚ÛŒÙ…Øª: ÛµÛ° ğŸª™</div>
          </div>
          <button class="shop-buy" id="buyShieldBtn">Ø®Ø±ÛŒØ¯</button>
        </div>

        <div class="shop-card">
          <div class="shop-info">
            <div class="shop-title">Ù…ÙˆØ´Ú© ÙˆÛŒÚ˜Ù‡ ğŸš€</div>
            <div class="shop-desc">Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ù‚ÙˆÛŒØ› Ø´Ù„ÛŒÚ© Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¢ÛŒÚ©Ù† ğŸš€ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡.</div>
            <div class="shop-desc">Ù‚ÛŒÙ…Øª: Û·Û° ğŸª™</div>
          </div>
          <button class="shop-buy" id="buyRocketBtn">Ø®Ø±ÛŒØ¯</button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="secondary" id="shopCloseBtn">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <script>
    // ======== Canvas & Ø§Ù†Ø¯Ø§Ø²Ù‡ ========
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");


// ======== Intro Video ========
const introScreen = document.getElementById("introScreen");
const gameWrapper = document.getElementById("gameWrapper");
const introVideo   = document.getElementById("introVideo");
const introMuteBtn = document.getElementById("introMuteBtn");
const introSkipBtn = document.getElementById("introSkipBtn");

function finishIntro(){
  const startSfx = document.getElementById("startSfx");

  // ÙÛŒØ¯ Ø§ÙˆØª Ù‚Ø´Ù†Ú¯
  introScreen.style.transition = "opacity 0.7s ease";
  introScreen.style.opacity = "0";

  setTimeout(() => {
    introScreen.style.display = "none";
    gameWrapper.classList.remove("hidden-game");

    // Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ø´Ø±ÙˆØ¹ (Ø§Ú¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡)
    if (startSfx) {
      startSfx.currentTime = 0;
      startSfx.play().catch(()=>{});
    }
  }, 700);

  introVideo.pause();
  introVideo.currentTime = 0;
}

introVideo.addEventListener("ended", finishIntro);

introSkipBtn.addEventListener("click", finishIntro);

introMuteBtn.addEventListener("click", ()=>{
  introVideo.muted = !introVideo.muted;
  introMuteBtn.textContent = introVideo.muted ? "ğŸ”‡ ØµØ¯Ø§" : "ğŸ”Š ØµØ¯Ø§";
});

    
    function resizeCanvas(){
      const maxWidth = 420, ratio = 9/16;
      const width = Math.min(maxWidth, window.innerWidth - 32);
      const height = width / ratio;
      canvas.width = width; canvas.height = height;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    // ======== Ø¹Ù†Ø§ØµØ± UI ========
    const scoreEl = document.getElementById("score");
    const livesEl = document.getElementById("lives");
    const coinsEl = document.getElementById("coins");
    const levelLabel = document.getElementById("levelLabel");
    const resetRunBtn = document.getElementById("resetRunBtn");
    const livesPill = document.getElementById("livesPill");

    const startOverlay = document.getElementById("startOverlay");
    const levelOverlay = document.getElementById("levelOverlay");
    const gameOverOverlay = document.getElementById("gameOverOverlay");

    const startBtn = document.getElementById("startBtn");
    const continueBtn = document.getElementById("continueBtn");
    const nextLevelBtn = document.getElementById("nextLevelBtn");
    const restartBtn = document.getElementById("restartBtn");
    const finalScoreEl = document.getElementById("finalScore");
    const bestScoreEl = document.getElementById("bestScore");

    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const fireBtn = document.getElementById("fireBtn");

    const aboutBtn = document.getElementById("aboutBtn");
    const shopBtn = document.getElementById("shopBtn");
    const aboutModal = document.getElementById("aboutModal");
    const shopModal = document.getElementById("shopModal");
    const aboutCloseBtn = document.getElementById("aboutCloseBtn");
    const shopCloseBtn = document.getElementById("shopCloseBtn");

    const buyTripleBtn = document.getElementById("buyTripleBtn");
    const buyShieldBtn = document.getElementById("buyShieldBtn");
    const buyRocketBtn = document.getElementById("buyRocketBtn");
    const shopCoinsEl = document.getElementById("shopCoins");

    const soundToggleBtn = document.getElementById("soundToggle");

    // Ø¢ÛŒÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
    const shieldUseBtn = document.getElementById("shieldUseBtn");
    const rocketUseBtn = document.getElementById("rocketUseBtn");
    const tripleUseBtn = document.getElementById("tripleUseBtn");
    const shieldCountEl = document.getElementById("shieldCount");
    const rocketCountEl = document.getElementById("rocketCount");
    const tripleCountEl = document.getElementById("tripleCount");

    const motivationTextEl = document.getElementById("motivationText");
    const MOTIVATIONS = [
      "ÛŒØ§Ø¯ Ø®Ø¯Ø§ Ø¨Ù‡ Ù‚Ù„Ø¨ Ø¢Ø±Ø§Ù…Ø´ Ù…ÛŒâ€ŒØ¨Ø®Ø´Ù‡.",
      "Ø¯Ø± Ù‡ÛŒÚ† Ø­Ø§Ù„ØªÛŒ Ø§Ø² ÛŒØ§Ø¯ Ø®Ø¯Ø§ ØºØ§ÙÙ„ Ù†Ø´Ùˆ.",
      "Ø¹Ø´Ù‚ Ø¨Ù‡ Ù¾Ø¯Ø± Ùˆ Ù…Ø§Ø¯Ø± Ø¹Ø´Ù‚ Ø¨Ù‡ Ø®Ø¯Ø§Ø³Øª.",
      "Ù…Ø­Ø¨ØªØŒ Ø§Ø®Ù„Ø§Ù‚ØŒ Ø§Ø¯Ø¨ Ú¯Ù†Ø¬â€ŒÙ‡Ø§ÛŒ ØªÙˆØ³Øª."
    ];
    let motivationIndex = 0;
    function updateMotivation(){
      if(!motivationTextEl) return;
      motivationTextEl.textContent = MOTIVATIONS[motivationIndex];
      motivationIndex = (motivationIndex + 1) % MOTIVATIONS.length;
    }

    // ======== Ø³ÛŒØ³ØªÙ… ØµØ¯Ø§ (Ø³Ø§Ø¯Ù‡) ========
    let soundEnabled = true;
    let audioCtx = null;

    function playTone(freq, duration=0.15, type="square", volume=0.18){
      if(!soundEnabled) return;
      try{
        if(!audioCtx){
          const AC = window.AudioContext || window.webkitAudioContext;
          if(!AC) return;
          audioCtx = new AC();
        }
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0.001, now);
        gain.gain.exponentialRampToValueAtTime(volume, now+0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, now+duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now+duration);
      }catch(e){}
    }

    const sfxShoot   = () => playTone(520, 0.09, "square", 0.2);
    const sfxHit     = () => playTone(200, 0.15, "sawtooth", 0.25);
    const sfxPower   = () => playTone(800, 0.2, "triangle", 0.22);
    const sfxBoss    = () => playTone(140, 0.4, "sawtooth", 0.28);
    const sfxGameOver= () => { playTone(260,0.25,"square",0.22); setTimeout(()=>playTone(180,0.3,"square",0.2),180); };

    soundToggleBtn.addEventListener("click", ()=>{
      soundEnabled = !soundEnabled;
      soundToggleBtn.textContent = soundEnabled ? "ğŸ”Š" : "ğŸ”‡";
    });

    // ======== ØªØµØ§ÙˆÛŒØ± ØªØ§Ù†Ú© Ùˆ ØºÙˆÙ„ ========
    const tankImg = new Image();
    tankImg.src = "https://cdnfa.com/irangiah/a9be/uploads/tank/tank.webp";

    const bossImages = Array(20).fill("https://cdnfa.com/irangiah/a9be/uploads/tank/ghool1.webp");
    const bossImg = new Image();

    // ======== ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ ========
    let tank = { x:0,y:0,w:60,h:36,speed:4 };
    let bullets = [];
    let enemies = [];
    let powerUps = [];
    let particles = [];

    let score = 0;
    let coins = 0;
    let lives = 3;

    // Ø§Ù†Ø¨Ø§Ø± Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
    let inventory = { shield:0, triple:0, rocket:0 };
    let rocketArmed = false;   // Ø´Ù„ÛŒÚ© Ø¨Ø¹Ø¯ÛŒ Ù…ÙˆØ´Ú©ÛŒ Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ù†Ù‡

    let gameRunning = false;
    let lastEnemyTime = 0;
    let lastPowerUpTime = 0;

    let hitFlash = 0;
    let shakeTime = 0;
    let bgOffset = 0;

    let moveLeft = false;
    let moveRight = false;

    const badLabels = [
      "Ø¯Ø±ÙˆØº","ØªÙ‡Ù…Øª","ØºÛŒØ¨Øª","Ù…Ø±Ø¯Ù…â€ŒØ¢Ø²Ø§Ø±ÛŒ","Ú¯Ø±Ø§Ù†ÙØ±ÙˆØ´ÛŒ","Ø¨ÛŒâ€ŒØ§Ø¯Ø¨ÛŒ","Ø¯Ø´Ù†Ø§Ù…","ØªÙ†Ø¨Ù„ÛŒ",
      "Ø­Ø³Ø§Ø¯Øª","Ø¨ÛŒâ€ŒØ­ÛŒØ§ÛŒÛŒ","Ø¨ÛŒâ€ŒØ­Ø¬Ø§Ø¨ÛŒ","ØªØ±Ú© Ù†Ù…Ø§Ø²","Ù‚Ø¶Ø§ÙˆØª","Ø®ÙˆØ¯Ú©Ù…â€ŒØ¨ÛŒÙ†ÛŒ","Ø®ÙˆØ¯Ø®ÙˆØ§Ù‡ÛŒ",
      "Ù„Ø¬Ø§Ø¬Øª","Ú†Ø´Ù… Ùˆ Ù‡Ù…â€ŒÚ†Ø´Ù…ÛŒ","Ø­Ù‚â€ŒØ§Ù„Ù†Ø§Ø³","Ø­ÛŒÙˆØ§Ù†â€ŒØ¢Ø²Ø§Ø±ÛŒ","Ù‚Ù‡Ø±",
      "Ø±ÛŒØ§","Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ","ØªØ±Ø³","Ú©ÛŒÙ†Ù‡","Ù¾Ø±Ø®Ø§Ø´Ú¯Ø±ÛŒ","ØªØ¹Ù„Ù„","Ø¨Ø¯Ø¨ÛŒÙ†ÛŒ"
    ];

    // Û²Û° Ù…Ø±Ø­Ù„Ù‡
    const LEVELS = [];
    for(let i=1;i<=20;i++){
      LEVELS.push({
        id: i,
        label: `Ù…Ø±Ø­Ù„Ù‡ ${i}`,
        goal: 120 + (i-1)*35,
        enemySpeed: 1.6 + (i-1)*0.12,
        spawnInterval: 1100 - (i-1)*35,
        bossName: `ØºÙˆÙ„ Ù…Ø±Ø­Ù„Ù‡ ${i}`,
        bossHP: 120 + (i-1)*20,
        bossImgIndex: i-1
      });
    }

    let currentLevelIndex = 0;
    let levelGoal = LEVELS[0].goal;
    let spawnInterval = LEVELS[0].spawnInterval;
    let enemyBaseSpeed = LEVELS[0].enemySpeed;

    let bossSpawned = false;
    let bossAlive = false;

    const POWER_TYPES = ["shield","triple","slow","rocket"];

    let activePowerUps = { shield:false, triple:false, slow:false };
    let powerTimers = {};

    const STORAGE_KEY = "tavita_tank_state_v4";

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch{ return null; }
    }
    function saveState(){
      const prev = loadState() || {};
      const bestScore = Math.max(score, prev.bestScore || 0);
      const data = {
        bestScore,
        lastLevel: LEVELS[currentLevelIndex].id,
        coins,
        inventory
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function applyLoadedState(){
      const saved = loadState();
      if(!saved){
        continueBtn.style.display = "none";
        return;
      }
      continueBtn.style.display = "inline-block";
      coins = saved.coins || 0;
      inventory = saved.inventory || {shield:0,triple:0,rocket:0};
      coinsEl.textContent = coins;
      updateInventoryUI();
    }

    tankImg.onload = ()=>{
      const ratio = tankImg.naturalHeight / tankImg.naturalWidth || 0.6;
      tank.w = canvas.width * 0.18;
      tank.h = tank.w * ratio;
      tank.x = canvas.width/2 - tank.w/2;
      tank.y = canvas.height - tank.h - 18;
    };

    function updateInventoryUI(){
      shieldCountEl.textContent = inventory.shield || 0;
      rocketCountEl.textContent = inventory.rocket || 0;
      tripleCountEl.textContent = inventory.triple || 0;

      shieldUseBtn.classList.toggle("disabled", !inventory.shield);
      rocketUseBtn.classList.toggle("disabled", !inventory.rocket);
      tripleUseBtn.classList.toggle("disabled", !inventory.triple);
    }

    function createBlobPoints(w,h){
      const pts=[];
      const jitter = 6 + Math.random()*6;
      pts.push({x:0+Math.random()*jitter, y:0+Math.random()*jitter});
      pts.push({x:w*0.5 + (Math.random()*jitter-jitter/2), y:0});
      pts.push({x:w - Math.random()*jitter, y:0+Math.random()*jitter});
      pts.push({x:w, y:h*0.5 + (Math.random()*jitter-jitter/2)});
      pts.push({x:w - Math.random()*jitter, y:h - Math.random()*jitter});
      pts.push({x:w*0.5 + (Math.random()*jitter-jitter/2), y:h});
      pts.push({x:0+Math.random()*jitter, y:h - Math.random()*jitter});
      pts.push({x:0, y:h*0.5 + (Math.random()*jitter-jitter/2)});
      return pts;
    }

    function drawPolygon(x,y,points){
      ctx.beginPath();
      ctx.moveTo(x+points[0].x, y+points[0].y);
      for(let i=1;i<points.length;i++){
        ctx.lineTo(x+points[i].x, y+points[i].y);
      }
      ctx.closePath();
    }

    function rectCircleCollide(cx,cy,cr, rx,ry,rw,rh){
      const testX = Math.max(rx, Math.min(cx, rx+rw));
      const testY = Math.max(ry, Math.min(cy, ry+rh));
      const distX = cx - testX;
      const distY = cy - testY;
      return (distX*distX + distY*distY) <= cr*cr;
    }

    // Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    function drawBackground(){
      const grad = ctx.createRadialGradient(
        canvas.width/2, canvas.height*0.1, 20,
        canvas.width/2, canvas.height, canvas.height
      );
      grad.addColorStop(0,"#0b1120");
      grad.addColorStop(0.5,"#020617");
      grad.addColorStop(1,"#000");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.save();
      ctx.strokeStyle = "rgba(56,189,248,0.28)";
      ctx.lineWidth = 1.3;
      ctx.shadowColor = "rgba(56,189,248,0.5)";
      ctx.shadowBlur = 6;
      for(let i=0;i<9;i++){
        const y = (canvas.height - 16) - (i*26) + bgOffset;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(canvas.width,y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawTank(){
      const {x,y,w,h} = tank;

      if(tankImg.complete && tankImg.naturalWidth>0){
        ctx.drawImage(tankImg, x, y, w, h);
      }else{
        const grad = ctx.createLinearGradient(x,y,x+w,y+h);
        grad.addColorStop(0,"#38bdf8");
        grad.addColorStop(1,"#0f172a");
        ctx.fillStyle = grad;
        ctx.fillRect(x,y,w,h);
      }

      if(activePowerUps.shield){
        ctx.strokeStyle = "rgba(56,189,248,0.7)";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(x+w/2, y+h/2, w*0.8, 0, Math.PI*2);
        ctx.stroke();
      }
    }

    function drawBullets(){
      bullets.forEach(b=>{
        const grad = ctx.createRadialGradient(b.x,b.y,1,b.x,b.y,b.r);
        grad.addColorStop(0,"#fff");
        grad.addColorStop(1, b.isRocket ? "#22c55e" : "#f97316");
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
        ctx.fill();
      });
    }

    function drawEnemies(){
      enemies.forEach(e=>{
        if(e.isBoss){
          const {x,y,w,h} = e;

          if(bossImg.complete && bossImg.naturalWidth>0){
            const scale = 0.75;
            const iw = w * scale;
            const ih = h * scale;
            const ix = x + (w - iw)/2;
            const iy = y + (h - ih)/2;
            ctx.drawImage(bossImg, ix, iy, iw, ih);
          }

          ctx.fillStyle = "#ffffff";
          ctx.font = "bold 13px Vazir, Vazirmatn, system-ui";
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          ctx.fillText("HP: "+e.hp, x+w/2, y+4);

          ctx.font = "bold 13px Vazir, Vazirmatn, system-ui";
          ctx.textBaseline = "bottom";
          ctx.fillText(e.bossName, x+w/2, y+h-4);

          return;
        }

        const grad = ctx.createLinearGradient(e.x,e.y,e.x+e.w,e.y+e.h);
        grad.addColorStop(0,e.colorStart);
        grad.addColorStop(1,e.colorEnd);
        ctx.fillStyle = grad;
        ctx.strokeStyle = "rgba(15,23,42,0.9)";
        ctx.lineWidth=2;

        if(e.points){
          drawPolygon(e.x,e.y,e.points);
          ctx.fill(); ctx.stroke();
        }else{
          ctx.fillRect(e.x,e.y,e.w,e.h);
          ctx.strokeRect(e.x,e.y,e.w,e.h);
        }

        ctx.fillStyle="#0f172a";
        ctx.font="bold 12px Vazir, Vazirmatn, system-ui";
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(e.label, e.x+e.w/2, e.y+e.h/2);
      });
    }

    function drawParticles(){
      ctx.save();
      particles.forEach(p=>{
        ctx.globalAlpha = p.life/p.maxLife;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x,p.y,3,0,Math.PI*2);
        ctx.fill();
      });
      ctx.restore();
    }
    function createExplosion(cx,cy,color){
      for(let i=0;i<12;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 1 + Math.random()*2.2;
        particles.push({
          x:cx,y:cy,
          vx:Math.cos(angle)*speed,
          vy:Math.sin(angle)*speed,
          life:26,maxLife:26,
          color
        });
      }
    }

    function drawPowerUps(){
      powerUps.forEach(p=>{
        const {x,y,r,type} = p;
        let c1="#a855f7";
        if(type==="shield") c1="#22c55e";
        if(type==="triple") c1="#eab308";
        if(type==="slow")   c1="#38bdf8";
        if(type==="rocket") c1="#f97316";
        const grad = ctx.createRadialGradient(x,y,1,x,y,r);
        grad.addColorStop(0,"#fff");
        grad.addColorStop(1,c1);
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

        ctx.font="bold 11px Vazir, Vazirmatn, system-ui";
        ctx.fillStyle="#020617";
        ctx.textAlign="center"; ctx.textBaseline="middle";
        let icon = "â¬†";
        if(type==="shield") icon="ğŸ›¡";
        else if(type==="triple") icon="Ã—3";
        else if(type==="slow") icon="â³";
        else if(type==="rocket") icon="ğŸš€";
        ctx.fillText(icon, x,y);
      });
    }

    function spawnEnemy(isBoss=false){
      if(isBoss){
        const lvl = LEVELS[currentLevelIndex];
        const w = canvas.width*0.65;
        const h = canvas.height*0.52;
        const x = (canvas.width-w)/2;
        const y = -h-20;
        enemies.push({
          x,y,w,h,
          speed: enemyBaseSpeed*0.7,
          isBoss:true,
          bossName:lvl.bossName,
          hp:lvl.bossHP
        });
        bossAlive = true;

        const bossImgSrc = bossImages[lvl.bossImgIndex] || bossImages[0];
        bossImg.src = bossImgSrc;

        sfxBoss();
        return;
      }

      const laneCount=5, laneWidth=canvas.width/laneCount;
      const laneIndex=Math.floor(Math.random()*laneCount);
      const w=laneWidth*0.72, h=34;
      const x=laneIndex*laneWidth+(laneWidth-w)/2;
      const y=-h-8;

      const colors=[
        ["#f97316","#fb923c"],
        ["#22c55e","#4ade80"],
        ["#3b82f6","#6366f1"],
        ["#e11d48","#f97316"],
        ["#a855f7","#6366f1"]
      ];
      const pair=colors[Math.floor(Math.random()*colors.length)];
      const label=badLabels[Math.floor(Math.random()*badLabels.length)];

      enemies.push({
        x,y,w,h,
        speed: enemyBaseSpeed + Math.random()*0.8,
        colorStart:pair[0], colorEnd:pair[1],
        label, isBoss:false,
        points:createBlobPoints(w,h)
      });
    }

    function spawnPowerUp(){
      const laneCount=5, laneWidth=canvas.width/laneCount;
      const laneIndex=Math.floor(Math.random()*laneCount);
      const x=laneIndex*laneWidth+laneWidth/2;
      powerUps.push({
        x, y:-15, r:13, speed:1.1,
        type: POWER_TYPES[Math.floor(Math.random()*POWER_TYPES.length)]
      });
    }

    function activatePowerUp(type){
      if(type === "rocket") return; // Ù…ÙˆØ´Ú© Ø²Ù…Ø§Ù†â€ŒØ¯Ø§Ø± Ù†ÛŒØ³Øª

      activePowerUps[type]=true;
      sfxPower();
      if(powerTimers[type]) clearTimeout(powerTimers[type]);
      powerTimers[type]=setTimeout(()=>{
        activePowerUps[type]=false;
      }, type==="shield"?12000:type==="triple"?10000:8000);
    }

    function fireBullet(){
      if(!gameRunning) return;

      const base = () => ({
        x: tank.x+tank.w/2,
        y: tank.y-6,
        r: 7,
        speed: 6,
        isRocket:false,
        damage:3
      });

      // Ø§Ú¯Ø± Ù…ÙˆØ´Ú© Ù…Ø³Ù„Ø­ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø´Ù„ÛŒÚ© Ø¨Ø¹Ø¯ÛŒ Ù…ÙˆØ´Ú©ÛŒ Ø§Ø³Øª (Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)
      if(rocketArmed && inventory.rocket > 0){
        const b = base();
        b.isRocket = true;
        b.r = 11;
        b.speed = 7;
        b.damage = 12;
        bullets.push(b);
        inventory.rocket--;
        rocketArmed = false;
        updateInventoryUI();
        saveState();
      }else if(activePowerUps.triple){
        bullets.push(
          {...base(), x:tank.x+tank.w*0.3},
          {...base(), x:tank.x+tank.w*0.5},
          {...base(), x:tank.x+tank.w*0.7}
        );
      }else{
        bullets.push(base());
      }

      if(navigator.vibrate) navigator.vibrate(15);
      sfxShoot();
    }

    function flashLifeDanger(){
      if(!livesPill) return;
      livesPill.classList.add("danger");
      setTimeout(()=>livesPill.classList.remove("danger"),700);
    }

    let frameId = null;

    function update(){
      if(moveLeft) tank.x -= tank.speed;
      if(moveRight) tank.x += tank.speed;
      tank.x = Math.max(4, Math.min(canvas.width-tank.w-4, tank.x));

      const enemySpeedFactor = activePowerUps.slow?0.5:1;
      const enemySpawnFactor = activePowerUps.slow?1.5:1;

      bgOffset += 1.4*enemySpeedFactor;
      if(bgOffset>26) bgOffset-=26;

      bullets.forEach(b=> b.y -= b.speed);
      bullets = bullets.filter(b=> b.y+b.r>0);

      enemies.forEach(e=> e.y += e.speed*enemySpeedFactor);

      powerUps.forEach(p=> p.y += p.speed);
      powerUps = powerUps.filter(p=> p.y-p.r < canvas.height+10);

      particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--;
      });
      particles = particles.filter(p=>p.life>0);

      const now = performance.now();
      const lvl = LEVELS[currentLevelIndex];

      if(!bossSpawned && score >= lvl.goal*0.65){
        spawnEnemy(true);
        bossSpawned=true;
      }

      if(now-lastEnemyTime > spawnInterval*enemySpawnFactor){
        spawnEnemy(false);
        lastEnemyTime = now;
      }

      if(now-lastPowerUpTime>8000){
        spawnPowerUp();
        lastPowerUpTime=now;
      }

      bullets.forEach((b,bi)=>{
        enemies.forEach((e,ei)=>{
          if(rectCircleCollide(b.x,b.y,b.r, e.x,e.y,e.w,e.h)){
            bullets.splice(bi,1);
            const cx=e.x+e.w/2, cy=e.y+e.h/2;
            createExplosion(cx,cy,e.colorStart||"#f97316");
            sfxHit();

            if(e.isBoss){
              e.hp -= b.damage;
              if(e.hp<=0){
                enemies.splice(ei,1);
                bossAlive=false;
                score += 80;
                coins += 40;
                scoreEl.textContent=score;
                coinsEl.textContent=coins;
                saveState();
              }
            }else{
              enemies.splice(ei,1);
              score += 7;
              coins += 2;
              scoreEl.textContent=score;
              coinsEl.textContent=coins;
            }
          }
        });
      });

      // Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§: Ø¨Ù‡ Ø§Ù†Ø¨Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯ (Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)
      powerUps.forEach((p,pi)=>{
        if(rectCircleCollide(p.x,p.y,p.r, tank.x,tank.y,tank.w,tank.h)){
          if(p.type === "shield" || p.type === "triple" || p.type==="rocket"){
            inventory[p.type] = (inventory[p.type] || 0) + 1;
            updateInventoryUI();
            sfxPower();
            saveState();
          }else if(p.type==="slow"){
            activatePowerUp("slow");
          }
          powerUps.splice(pi,1);
          if(navigator.vibrate) navigator.vibrate(25);
        }
      });

      enemies.forEach((e,ei)=>{
        const collideWithTank =
          e.x < tank.x+tank.w &&
          e.x+e.w > tank.x &&
          e.y < tank.y+tank.h &&
          e.y+e.h > tank.y;

        const outBottom = e.y+e.h >= canvas.height-5;

        if(collideWithTank || outBottom){
          enemies.splice(ei,1);

          if(activePowerUps.shield){
            activePowerUps.shield=false;
          }else{
            lives--;
            livesEl.textContent=lives;
            hitFlash=1; shakeTime= e.isBoss ? 12 : 10;
            flashLifeDanger();
            sfxHit();
            if(navigator.vibrate) navigator.vibrate(e.isBoss ? 100 : 80);
            if(lives<=0){
              endGame(); return;
            }else if(e.isBoss){
              bossAlive=false;
              bossSpawned=false;
            }
          }
        }
      });

      const levelCleared = score >= lvl.goal && bossSpawned && !bossAlive;
      if(levelCleared){
        lives += 2;
        livesEl.textContent = lives;
        gameRunning=false;
        saveState();
        levelOverlay.classList.remove("hidden");
      }
    }

    function gameLoop(){
      if(!gameRunning) return;

      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.save();
      if(shakeTime>0){
        const intensity=4;
        ctx.translate((Math.random()*2-1)*intensity, (Math.random()*2-1)*intensity);
        shakeTime--;
      }

      drawBackground();
      update();
      drawEnemies();
      drawPowerUps();
      drawParticles();
      drawBullets();
      drawTank();

      ctx.restore();

      if(hitFlash>0){
        const alpha = hitFlash*0.45;
        const cx=tank.x+tank.w/2, cy=tank.y+tank.h/2;
        const grad=ctx.createRadialGradient(cx,cy,10,cx,cy,tank.w*2.2);
        grad.addColorStop(0,`rgba(248,113,113,${alpha})`);
        grad.addColorStop(1,"rgba(248,113,113,0)");
        ctx.fillStyle=grad;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        hitFlash-=0.05;
      }

      frameId = requestAnimationFrame(gameLoop);
    }

    function resetGameState(startFromLevelIndex = 0){
      bullets=[]; enemies=[]; powerUps=[]; particles=[];
      score=0; lives=3;
      bossSpawned=false; bossAlive=false;
      hitFlash=0; shakeTime=0; bgOffset=0;
      rocketArmed=false;

      currentLevelIndex = startFromLevelIndex;
      const lvl = LEVELS[currentLevelIndex];
      levelGoal = lvl.goal;
      spawnInterval = Math.max(550, lvl.spawnInterval);
      enemyBaseSpeed = lvl.enemySpeed;

      levelLabel.textContent = lvl.label;
      scoreEl.textContent = score;
      livesEl.textContent = lives;
      coinsEl.textContent = coins;

      const ratio = tankImg.naturalHeight / tankImg.naturalWidth || 0.6;
      tank.w = canvas.width * 0.18;
      tank.h = tank.w * ratio;
      tank.x = canvas.width/2 - tank.w/2;
      tank.y = canvas.height - tank.h - 18;
    }

    function startGame(fromLevelIndex=0){
      if(frameId) cancelAnimationFrame(frameId);

      resetGameState(fromLevelIndex);
      startOverlay.classList.add("hidden");
      levelOverlay.classList.add("hidden");
      gameOverOverlay.classList.add("hidden");
      gameRunning=true;
      lastEnemyTime=performance.now();
      lastPowerUpTime=performance.now();
      gameLoop();
    }

    function endGame(){
      gameRunning=false;
      if(frameId) cancelAnimationFrame(frameId);

      finalScoreEl.textContent=score;
      const saved=loadState();
      const best=Math.max(score, saved?.bestScore || 0);
      bestScoreEl.textContent=best;
      saveState();
      sfxGameOver();
      gameOverOverlay.classList.remove("hidden");
    }

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    startBtn.addEventListener("click", ()=> startGame(0));

    continueBtn.addEventListener("click", ()=>{
      const saved=loadState();
      if(!saved){ startGame(0); return; }
      const idx=LEVELS.findIndex(l=>l.id===saved.lastLevel);
      startGame(idx>=0?idx:0);
    });

    nextLevelBtn.addEventListener("click", ()=>{
      currentLevelIndex++;
      if(currentLevelIndex>=LEVELS.length) currentLevelIndex=0;
      startGame(currentLevelIndex);
    });

    restartBtn.addEventListener("click", ()=> startGame(0));
    resetRunBtn.addEventListener("click", ()=> startGame(0));

    document.addEventListener("keydown",(e)=>{
      if(e.code==="ArrowLeft") moveLeft=true;
      else if(e.code==="ArrowRight") moveRight=true;
      else if(e.code==="Space"){
        e.preventDefault();
        fireBullet();
      }
    });
    document.addEventListener("keyup",(e)=>{
      if(e.code==="ArrowLeft") moveLeft=false;
      else if(e.code==="ArrowRight") moveRight=false;
    });

    function bindHold(btn, cb){
      const start=(e)=>{e.preventDefault();cb(true);};
      const end=(e)=>{e.preventDefault();cb(false);};
      btn.addEventListener("mousedown",start);
      btn.addEventListener("mouseup",end);
      btn.addEventListener("mouseleave",end);
      btn.addEventListener("touchstart",start,{passive:false});
      btn.addEventListener("touchend",end);
      btn.addEventListener("touchcancel",end);
    }
    bindHold(leftBtn,(v)=> moveLeft=v);
    bindHold(rightBtn,(v)=> moveRight=v);

    fireBtn.addEventListener("click",(e)=>{e.preventDefault();fireBullet();});
    fireBtn.addEventListener("touchstart",(e)=>{e.preventDefault();fireBullet();},{passive:false});

    aboutBtn.addEventListener("click", ()=> aboutModal.classList.remove("hidden"));
    aboutCloseBtn.addEventListener("click", ()=> aboutModal.classList.add("hidden"));

    shopBtn.addEventListener("click", ()=>{
      shopModal.classList.remove("hidden");
      refreshShopUI();
    });
    shopCloseBtn.addEventListener("click", ()=> shopModal.classList.add("hidden"));

    function refreshShopUI(){
      shopCoinsEl.textContent = coins;
      buyTripleBtn.disabled = coins < 60;
      buyShieldBtn.disabled = coins < 50;
      buyRocketBtn.disabled = coins < 70;
    }

    // Ø®Ø±ÛŒØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ -> ÙÙ‚Ø· Ø¨Ù‡ Ø§Ù†Ø¨Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
    buyTripleBtn.addEventListener("click", ()=>{
      if(coins<60) return;
      coins-=60; coinsEl.textContent=coins;
      inventory.triple = (inventory.triple||0)+1;
      updateInventoryUI();
      saveState(); refreshShopUI();
    });

    buyShieldBtn.addEventListener("click", ()=>{
      if(coins<50) return;
      coins-=50; coinsEl.textContent=coins;
      inventory.shield = (inventory.shield||0)+1;
      updateInventoryUI();
      saveState(); refreshShopUI();
    });

    buyRocketBtn.addEventListener("click", ()=>{
      if(coins<70) return;
      coins-=70; coinsEl.textContent=coins;
      inventory.rocket = (inventory.rocket||0)+1;
      updateInventoryUI();
      saveState(); refreshShopUI();
    });

    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø² Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
    shieldUseBtn.addEventListener("click", ()=>{
      if(!gameRunning) return;
      if(inventory.shield>0 && !activePowerUps.shield){
        inventory.shield--;
        updateInventoryUI();
        activatePowerUp("shield");
        saveState();
      }
    });

    tripleUseBtn.addEventListener("click", ()=>{
      if(!gameRunning) return;
      if(inventory.triple>0 && !activePowerUps.triple){
        inventory.triple--;
        updateInventoryUI();
        activatePowerUp("triple");
        saveState();
      }
    });

    rocketUseBtn.addEventListener("click", ()=>{
      if(!gameRunning) return;
      if(inventory.rocket>0){
        rocketArmed = true; // Ø´Ù„ÛŒÚ© Ø¨Ø¹Ø¯ÛŒ Ù…ÙˆØ´Ú©ÛŒ Ø§Ø³Øª
        if(navigator.vibrate) navigator.vibrate(30);
      }
    });

    // Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
    resetGameState(0);
    drawBackground(); drawTank();
    applyLoadedState();
    updateInventoryUI();
    updateMotivation();
    setInterval(updateMotivation, 10000);

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
    setTimeout(()=>{
      try{
        fireBtn.scrollIntoView({ behavior:"smooth", block:"end" });
      }catch(e){}
    }, 600);
  </script>

</body>
</html>
